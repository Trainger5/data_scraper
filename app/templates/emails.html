{% extends "base.html" %}

{% block title %}Emails - Email Extractor Pro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1><i class="fas fa-envelope"></i> Extracted Emails</h1>
        <p>View and filter all extracted email addresses</p>
    </div>
    <div class="actions">
        <button class="btn btn-secondary" onclick="exportEmails('csv')"><i class="fas fa-file-csv"></i> Export
            CSV</button>
        <button class="btn btn-secondary" onclick="exportEmails('json')"><i class="fas fa-file-code"></i> Export
            JSON</button>
    </div>
</div>

<!-- Filters -->
<div class="glass-card">
    <div class="card-header">
        <div class="card-title"><i class="fas fa-filter"></i> Filters</div>
    </div>
    <div class="row">
        <div class="col-4">
            <div class="form-group">
                <label class="form-label">Search Email</label>
                <input type="text" id="emailSearch" class="form-control" placeholder="Search by email...">
            </div>
        </div>
        <div class="col-4">
            <div class="form-group">
                <label class="form-label">Domain</label>
                <input type="text" id="domainFilter" class="form-control" placeholder="e.g. gmail.com">
            </div>
        </div>
        <div class="col-4">
            <div class="form-group">
                <label class="form-label">Source URL</label>
                <input type="text" id="sourceFilter" class="form-control" placeholder="Source website...">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <button class="btn btn-primary" onclick="applyFilters()"><i class="fas fa-search"></i> Apply
                Filters</button>
            <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
        </div>
    </div>
</div>

<!-- Results -->
<div class="glass-card">
    <div class="card-header">
        <div class="card-title"><i class="fas fa-database"></i> Email Database</div>
        <div>
            <span class="badge badge-primary" id="totalEmails">0 Total</span>
        </div>
    </div>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Email</th>
                    <th>Business Name</th>
                    <th>Website</th>
                    <th>Address</th>
                    <th>Source</th>
                    <th>Found Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="emailsTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Loading emails...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div id="paginationInfo">Showing 0 - 0 of 0</div>
        <div id="paginationControls"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const perPage = 50;
    let allEmails = [];
    let filteredEmails = [];

    document.addEventListener('DOMContentLoaded', function () {
        loadEmails();
    });

    async function loadEmails() {
        try {
            const response = await fetch('/api/emails');
            const data = await response.json();
            allEmails = data.emails || [];
            filteredEmails = [...allEmails];
            displayEmails();
        } catch (error) {
            console.error('Error loading emails:', error);
            document.getElementById('emailsTableBody').innerHTML = `
            <tr><td colspan="8" style="text-align: center; color: var(--error);">
                <i class="fas fa-exclamation-circle"></i> Error loading emails
            </td></tr>
        `;
        }
    }

    function applyFilters() {
        const emailSearch = document.getElementById('emailSearch').value.toLowerCase();
        const domainFilter = document.getElementById('domainFilter').value.toLowerCase();
        const sourceFilter = document.getElementById('sourceFilter').value.toLowerCase();

        filteredEmails = allEmails.filter(email => {
            const matchesEmail = !emailSearch || email.email.toLowerCase().includes(emailSearch);
            const matchesDomain = !domainFilter || email.domain.toLowerCase().includes(domainFilter);
            const matchesSource = !sourceFilter || email.source_url.toLowerCase().includes(sourceFilter);
            return matchesEmail && matchesDomain && matchesSource;
        });

        currentPage = 1;
        displayEmails();
    }

    function clearFilters() {
        document.getElementById('emailSearch').value = '';
        document.getElementById('domainFilter').value = '';
        document.getElementById('sourceFilter').value = '';
        filteredEmails = [...allEmails];
        currentPage = 1;
        displayEmails();
    }

    function displayEmails() {
        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const paginatedEmails = filteredEmails.slice(start, end);

        document.getElementById('totalEmails').textContent = `${filteredEmails.length} Total`;

        if (paginatedEmails.length === 0) {
            document.getElementById('emailsTableBody').innerHTML = `
            <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <i class="fas fa-inbox"></i> No emails found
            </td></tr>
        `;
            document.getElementById('paginationInfo').textContent = 'Showing 0 - 0 of 0';
            document.getElementById('paginationControls').innerHTML = '';
            return;
        }

        const tbody = paginatedEmails.map((email, index) => `
        <tr>
            <td>${start + index + 1}</td>
            <td><strong>${email.email}</strong></td>
            <td>${email.business_name || 'NA'}</td>
            <td>${email.website ? `<a href="${email.website}" target="_blank"><i class="fas fa-external-link-alt"></i> Link</a>` : 'NA'}</td>
            <td>${email.address || 'NA'}</td>
            <td><a href="${email.source_url}" target="_blank" style="color: var(--primary); text-decoration: none;">
                ${truncateUrl(email.source_url, 30)}
            </a></td>
            <td>${formatDate(email.found_at)}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${email.email}')" title="Copy Email">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRow(this)" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

        document.getElementById('emailsTableBody').innerHTML = tbody;

        // Update pagination info
        document.getElementById('paginationInfo').textContent =
            `Showing ${start + 1} - ${Math.min(end, filteredEmails.length)} of ${filteredEmails.length}`;

        // Create pagination controls
        const totalPages = Math.ceil(filteredEmails.length / perPage);
        let paginationHTML = '';

        if (totalPages > 1) {
            paginationHTML += `<button class="btn btn-secondary" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span style="padding: 0 0.5rem;">...</span>';
                }
            }

            paginationHTML += `<button class="btn btn-secondary" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>`;
        }

        document.getElementById('paginationControls').innerHTML = paginationHTML;
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredEmails.length / perPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        displayEmails();
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Simple notification
            const notif = document.createElement('div');
            notif.textContent = 'Copied to clipboard!';
            notif.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:9999;animation:slideIn 0.3s ease;';
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        });
    }

    function deleteRow(btn) {
        if (confirm('Are you sure you want to delete this item?')) {
            const row = btn.closest('tr');
            row.remove();
            // Note: This only deletes from the view, not the database
        }
    }

    function truncateUrl(url, maxLength) {
        if (url.length <= maxLength) return url;
        return url.substring(0, maxLength) + '...';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function exportEmails(format) {
        const data = filteredEmails;
        if (format === 'csv') {
            const csv = [
                ['Email', 'Business Name', 'Website', 'Address', 'Source URL', 'Found Date'],
                ...data.map(e => [e.email, e.business_name || 'NA', e.website || 'NA', e.address || 'NA', e.source_url, e.found_at])
            ].map(row => row.join(',')).join('\n');

            downloadFile(csv, 'emails.csv', 'text/csv');
        } else {
            downloadFile(JSON.stringify(data, null, 2), 'emails.json', 'application/json');
        }
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}