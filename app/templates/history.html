{% extends "base.html" %}

{% block title %}History - Email Extractor Pro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Extraction History</h1>
        <p>View and manage your past search results</p>
    </div>
    <div class="actions">
        <button class="btn btn-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<div class="glass-card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Query</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Results</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for search in searches %}
                <tr>
                    <td>{{ search.created_at }}</td>
                    <td>
                        <div style="font-weight: 500; color: var(--text-primary);">{{ search.query }}</div>
                        <small class="text-muted">{{ search.engine }}</small>
                    </td>
                    <td>
                        {% if search.search_type == 'web' %}
                        <span class="badge badge-primary"><i class="fas fa-globe"></i> Web</span>
                        {% elif search.search_type == 'maps' %}
                        <span class="badge badge-success"><i class="fas fa-map-marker-alt"></i> Maps</span>
                        {% elif search.search_type == 'social' %}
                        <span class="badge badge-warning"><i class="fas fa-users"></i> Social</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if search.status == 'completed' %}
                        <span class="badge badge-success">Completed</span>
                        {% elif search.status == 'error' %}
                        <span class="badge badge-danger">Error</span>
                        {% else %}
                        <span class="badge badge-warning">{{ search.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex align-center gap-2">
                            <span title="Emails"><i class="fas fa-envelope text-muted"></i> {{ search.total_emails
                                }}</span>
                            <span title="Pages"><i class="fas fa-file text-muted"></i> {{ search.pages_crawled }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <a href="/api/export/{{ search.id }}?format=csv" class="btn btn-secondary"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Download CSV">
                                <i class="fas fa-download"></i>
                            </a>
                            <button class="btn btn-primary view-results-btn" data-search-id="{{ search.id }}"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                View
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-history fa-3x mb-3"></i>
                            <p>No extraction history found.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Results Modal (Hidden by default, shown by JS) -->
<div id="resultsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 1200px;">
        <div class="modal-header">
            <h3 class="modal-title">Search Results</h3>
            <button class="btn-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modalResultsBody">
            <div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Event delegation for View buttons
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.view-results-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const searchId = this.getAttribute('data-search-id');
                viewResults(searchId);
            });
        });
    });

    function viewResults(id) {
        const modal = document.getElementById('resultsModal');
        const body = document.getElementById('modalResultsBody');
        modal.style.display = 'flex';
        body.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Loading results...</p></div>';

        fetch(`/api/results/${id}`)
            .then(res => res.json())
            .then(data => {
                if (!data.results || (data.results.emails.length === 0 && data.results.phones.length === 0)) {
                    body.innerHTML = '<div class="text-center py-5 text-muted">No results found for this search.</div>';
                    return;
                }

                // Helper to format source
                const formatSource = (source) => {
                    try {
                        return new URL(source).hostname;
                    } catch (e) {
                        return source;
                    }
                };

                let html = '<div class="table-container"><table class="table"><thead><tr><th>Type</th><th>Value</th><th>Business</th><th>Website</th><th>Address</th><th>Source</th></tr></thead><tbody>';

                data.results.emails.forEach(item => {
                    html += `<tr>
                    <td><span class="badge badge-primary">Email</span></td>
                    <td><strong>${item.email}</strong></td>
                    <td>${item.business_name || 'NA'}</td>
                    <td>${item.website ? `<a href="${item.website}" target="_blank"><i class="fas fa-external-link-alt"></i> Link</a>` : 'NA'}</td>
                    <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.address || 'NA'}</td>
                    <td><span class="text-primary">${formatSource(item.source_url)}</span></td>
                </tr>`;
                });

                data.results.phones.forEach(item => {
                    html += `<tr>
                    <td><span class="badge badge-success">Phone</span></td>
                    <td><strong>${item.phone}</strong></td>
                    <td>${item.business_name || 'NA'}</td>
                    <td>${item.website ? `<a href="${item.website}" target="_blank"><i class="fas fa-external-link-alt"></i> Link</a>` : 'NA'}</td>
                    <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.address || 'NA'}</td>
                    <td><span class="text-primary">${formatSource(item.source_url)}</span></td>
                </tr>`;
                });

                html += '</tbody></table></div>';
                body.innerHTML = html;
            })
            .catch(err => {
                body.innerHTML = `<div class="text-center py-5 text-danger">Error loading results: ${err.message}</div>`;
            });
    }

    function closeModal() {
        document.getElementById('resultsModal').style.display = 'none';
    }

    // Close on click outside
    document.getElementById('resultsModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('resultsModal')) {
            closeModal();
        }
    });
</script>
{% endblock %}